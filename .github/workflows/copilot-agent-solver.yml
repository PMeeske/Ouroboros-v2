name: Copilot Agent Solver

on:
  issues:
    types:
      # Trigger when an issue is opened or labeled
      - opened
      - labeled

permissions:
  # Required to create PRs
  pull-requests: write
  # Required to read/write repo contents and issues
  contents: write
  issues: write

jobs:
  dispatch-copilot-agent:
    # Run if the issue has the 'copilot-agent' label
    if: contains(github.event.issue.labels.*.name, 'copilot-agent')
    runs-on: ubuntu-latest
    timeout-minutes: 30
    steps:
      - name: Checkout code
        uses: actions/checkout@b4ffde65f46336ab88eb53be808477a3936bae11  # v4.1.1

      - name: Run Gemini CLI for issue analysis
        uses: google-github-actions/run-gemini-cli@4cd2e3d9bfb87ac8a5be939321a01fef0401d233  # v0.1.15
        continue-on-error: true
        if: secrets.GOOGLE_CREDENTIALS != ''
        with:
          credentials_json: ${{ secrets.GOOGLE_CREDENTIALS }}
          model: 'gemini-pro'
          prompt: |
            Analyze this GitHub issue for a C# functional programming project (Ouroboros) using LangChain.
            
            Issue Title: ${{ github.event.issue.title }}
            
            Issue Description:
            ${{ github.event.issue.body }}
            
            Provide:
            1. Root cause analysis
            2. Recommended solution approach using functional programming patterns (monads, composition, etc.)
            3. Potential risks and edge cases
            4. Testing strategy
            
            Format as structured JSON:
            {
              "root_cause": "...",
              "solution_approach": "...",
              "risks": ["..."],
              "testing_strategy": "..."
            }

      - name: Authenticate, Install, and Run Copilot
        id: copilot-suggest
        shell: bash
        timeout-minutes: 15
        env:
          # Use a non-conflicting name for the secret
          GH_TOKEN_AUTH: ${{ secrets.GITHUB_TOKEN }}  # Changed variable name
          GH_ISSUE_NUMBER: ${{ github.event.issue.number }}
          GH_ISSUE_TITLE: ${{ github.event.issue.title }}
        run: |
          # Step 1: Perform the non-interactive login.
          # We pipe the secret from our non-conflicting env var.
          echo "${GH_TOKEN_AUTH}" | gh auth login --with-token
          echo "‚úÖ gh auth login completed."

          # Step 2: Install the Copilot extension.
          # We must now set GH_TOKEN for the remaining commands to use.
          export GH_TOKEN=${GH_TOKEN_AUTH}
          gh extension install github/gh-copilot
          echo "‚úÖ gh-copilot extension installed."

          # Step 3: Run the suggest command.
          echo "ü§ñ Asking Copilot to suggest a fix..."

          # Check if copilot_plan.sh was created
          if gh copilot suggest "Fix issue #${GH_ISSUE_NUMBER}: ${GH_ISSUE_TITLE}" --shell-out bash > copilot_plan.sh 2>&1; then
            echo "ü§ñ Copilot has generated a plan:"
            cat copilot_plan.sh

            # Make the plan executable
            chmod +x copilot_plan.sh

            # Run the plan generated by Copilot
            ./copilot_plan.sh
            echo "‚úÖ Copilot plan executed."
          else
            echo "‚ö†Ô∏è Copilot could not generate a plan for this issue"
            exit 0
          fi

      - name: Create Pull Request
        shell: bash
        continue-on-error: true
        timeout-minutes: 5
        env:
          GH_TOKEN: ${{ secrets.COPILOT_BOT_TOKEN || secrets.GITHUB_TOKEN }}  # Fallback to GITHUB_TOKEN
          GH_ISSUE_NUMBER: ${{ github.event.issue.number }}
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          if ! git diff --quiet HEAD; then
            echo "‚úÖ Changes found. Creating Pull Request..."
            # Create a branch for the changes
            BRANCH_NAME="copilot-fix-issue-${GH_ISSUE_NUMBER}"
            git checkout -b "$BRANCH_NAME"
            git add -A
            git commit -m "ü§ñ Copilot fix for issue #${GH_ISSUE_NUMBER}"
            git push origin "$BRANCH_NAME"

            # Create PR
            gh pr create \
              --title "ü§ñ Copilot fix for #${GH_ISSUE_NUMBER}" \
              --body "Addresses issue #${GH_ISSUE_NUMBER} with a solution suggested by \`gh copilot\`." \
              --base master \
              --head "$BRANCH_NAME"
          else
            echo "‚ö†Ô∏è No changes were made by Copilot. Skipping PR creation."
          fi
