name: Mutation Testing

permissions:
  contents: read

on:
  # Run mutation tests on a schedule (nightly at 2 AM UTC)
  schedule:
    - cron: '0 2 * * *'

  # Allow manual triggering from the Actions tab
  workflow_dispatch:
    inputs:
      mutation_level:
        description: 'Mutation level (Standard, Complete, or Basic)'
        required: false
        default: 'Standard'
        type: choice
        options:
          - Standard
          - Complete
          - Basic
      verbosity:
        description: 'Verbosity level'
        required: false
        default: 'info'
        type: choice
        options:
          - info
          - debug
          - trace

# Cancel in-progress runs for the same workflow on the same branch
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

env:
  DOTNET_VERSION: '10.0.x'

jobs:
  check-submodules:
    name: Check Submodule Availability
    runs-on: ubuntu-latest
    timeout-minutes: 5
    outputs:
      available: ${{ steps.check.outputs.available }}
    steps:
    - name: Checkout code
      uses: actions/checkout@b4ffde65f46336ab88eb53be808477a3936bae11  # v4.1.1

    - name: Try cloning submodules
      run: git submodule update --init --recursive 2>&1 || true

    - name: Check submodule availability
      id: check
      run: |
        MISSING=""
        for sub in .build foundation engine app; do
          if [ ! -f "$sub/.git" ] && [ ! -d "$sub/.git" ]; then
            MISSING="$MISSING $sub"
          fi
        done
        if [ -n "$MISSING" ]; then
          echo "available=false" >> $GITHUB_OUTPUT
          echo "::warning::Sub-repo(s) not available:$MISSING â€” skipping mutation tests"
        else
          echo "available=true" >> $GITHUB_OUTPUT
          echo "All submodules available"
        fi

  mutation-test:
    name: Mutation Tests (${{ matrix.category }})
    needs: check-submodules
    if: needs.check-submodules.outputs.available == 'true'
    runs-on: ubuntu-latest
    timeout-minutes: 120
    strategy:
      fail-fast: false
      matrix:
        include:
          - category: Core
            project: foundation/src/Ouroboros.Core/Ouroboros.Core.csproj
            config: stryker-config-core.json
          - category: Domain
            project: foundation/src/Ouroboros.Domain/Ouroboros.Domain.csproj
            config: stryker-config-domain.json
          - category: Pipeline
            project: engine/src/Ouroboros.Pipeline/Ouroboros.Pipeline.csproj
            config: stryker-config-pipeline.json
          - category: Tools
            project: foundation/src/Ouroboros.Tools/Ouroboros.Tools.csproj
            config: stryker-config-tools.json
          - category: Application
            project: app/src/Ouroboros.Application/Ouroboros.Application.csproj
            config: stryker-config-application.json
          - category: Providers
            project: engine/src/Ouroboros.Providers/Ouroboros.Providers.csproj
            config: stryker-config-providers.json
          - category: Agent
            project: engine/src/Ouroboros.Agent/Ouroboros.Agent.csproj
            config: stryker-config-agent.json
          - category: CLI
            project: app/src/Ouroboros.CLI/Ouroboros.CLI.csproj
            config: stryker-config-cli.json
          - category: WebApi
            project: app/src/Ouroboros.WebApi/Ouroboros.WebApi.csproj
            config: stryker-config-webapi.json

    steps:
    - name: Checkout code
      uses: actions/checkout@b4ffde65f46336ab88eb53be808477a3936bae11  # v4.1.1
      with:
        fetch-depth: 0
        submodules: recursive

    - name: Setup .NET
      uses: actions/setup-dotnet@4d6c8fcf3c8f7a60068d26b594648e99df24cee3  # v4.0.0
      with:
        dotnet-version: ${{ env.DOTNET_VERSION }}

    - name: Cache NuGet packages
      uses: actions/cache@v4
      with:
        path: ~/.nuget/packages
        key: ${{ runner.os }}-nuget-mutation-${{ matrix.category }}-${{ hashFiles('**/*.csproj') }}
        restore-keys: |
          ${{ runner.os }}-nuget-mutation-${{ matrix.category }}-
          ${{ runner.os }}-nuget-

    - name: Restore dependencies
      uses: nick-fields/retry@7152eba30c6575329ac0576536151aca5a72780e  # v3.0.0
      with:
        timeout_minutes: 10
        max_attempts: 3
        retry_wait_seconds: 30
        command: dotnet restore Ouroboros.slnx

    - name: Restore dotnet tools
      uses: nick-fields/retry@7152eba30c6575329ac0576536151aca5a72780e  # v3.0.0
      with:
        timeout_minutes: 5
        max_attempts: 3
        retry_wait_seconds: 10
        command: dotnet tool restore

    - name: Build solution
      run: dotnet build Ouroboros.slnx --configuration Release --no-restore
      timeout-minutes: 15

    - name: Run mutation tests (${{ matrix.category }})
      id: mutation-test
      timeout-minutes: 100
      run: |
        # Set mutation level from input or use default
        ML="${{ github.event.inputs.mutation_level || 'Standard' }}"

        echo "Running mutation tests for ${{ matrix.category }} with level: ${ML}"
        echo "Target project: ${{ matrix.project }}"
        echo "Config file: ${{ matrix.config }}"

        # Run Stryker with category-specific configuration file
        # Override mutation level only if provided as workflow input
        if [ -n "${{ github.event.inputs.mutation_level }}" ]; then
          dotnet stryker \
            --config-file "${{ matrix.config }}" \
            --project "${{ matrix.project }}" \
            --mutation-level "${ML}" \
            --max-concurrent-test-runners 4 \
            --since:master
        else
          dotnet stryker \
            --config-file "${{ matrix.config }}" \
            --project "${{ matrix.project }}" \
            --max-concurrent-test-runners 4 \
            --since:master
        fi

    - name: Extract mutation score
      id: mutation-score
      if: always()
      run: |
        # Install jq if not present
        if ! command -v jq &> /dev/null; then
          echo "Installing jq..."
          sudo apt-get update && sudo apt-get install -y jq
        fi
        
        # Find the most recent mutation report JSON
        REPORT=$(find . -name "mutation-report.json" -type f 2>/dev/null | sort -r | head -n 1)

        if [ -f "$REPORT" ]; then
          echo "Found mutation report: $REPORT"

          # Extract mutation score using jq
          SCORE=$(jq -r '.thresholds.high // .mutationScore // "N/A"' "$REPORT" 2>/dev/null || echo "N/A")
          MUTANTS=$(jq -r '.files | length // 0' "$REPORT" 2>/dev/null || echo "N/A")

          echo "mutation_score=${SCORE}" >> $GITHUB_OUTPUT
          echo "total_mutants=${MUTANTS}" >> $GITHUB_OUTPUT
          echo "report_found=true" >> $GITHUB_OUTPUT
        else
          echo "No mutation report found"
          echo "report_found=false" >> $GITHUB_OUTPUT
        fi

    - name: Display mutation test summary
      if: always()
      run: |
        echo "## ðŸ§¬ Mutation Testing Summary (${{ matrix.category }})" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY

        FOUND="${{ steps.mutation-score.outputs.report_found }}"
        if [ "$FOUND" = "true" ]; then
          echo "âœ… Mutation testing completed successfully" \
            >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Configuration:**" >> $GITHUB_STEP_SUMMARY
          ML="${{ github.event.inputs.mutation_level || 'Standard' }}"
          echo "- Category: ${{ matrix.category }}" >> $GITHUB_STEP_SUMMARY
          echo "- Project: ${{ matrix.project }}" >> $GITHUB_STEP_SUMMARY
          echo "- Mutation Level: ${ML}" >> $GITHUB_STEP_SUMMARY
          echo "- Target Framework: net10.0" >> $GITHUB_STEP_SUMMARY
          echo "- Test Project: Ouroboros.Tests" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Thresholds:**" >> $GITHUB_STEP_SUMMARY
          echo "- ðŸŸ¢ High: â‰¥80%" >> $GITHUB_STEP_SUMMARY
          echo "- ðŸŸ¡ Low: â‰¥60%" >> $GITHUB_STEP_SUMMARY
          echo "- ðŸ”´ Break: <50%" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "ðŸ“Š Download the artifacts to view the HTML report." \
            >> $GITHUB_STEP_SUMMARY
        else
          echo "âš ï¸ Mutation testing did not complete or reports missing." \
            >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Check the workflow logs for details." >> $GITHUB_STEP_SUMMARY
        fi

        echo "" >> $GITHUB_STEP_SUMMARY
        echo "---" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**About Mutation Testing:**" >> $GITHUB_STEP_SUMMARY
        echo "Mutation testing validates test quality by introducing" \
          >> $GITHUB_STEP_SUMMARY
        echo "small changes (mutations) to the code and verifying that" \
          >> $GITHUB_STEP_SUMMARY
        echo "tests detect these changes. A high mutation score indicates" \
          >> $GITHUB_STEP_SUMMARY
        echo "a robust test suite." >> $GITHUB_STEP_SUMMARY

    - name: Upload mutation report HTML
      uses: actions/upload-artifact@5d5d22a31266ced268874388b861e4b58bb5c2f3  # v4.3.1
      if: always()
      continue-on-error: true
      with:
        name: mutation-report-html-${{ matrix.category }}
        path: |
          StrykerOutput/**/reports/mutation-report.html
          **/mutation-report.html
        retention-days: 30
        if-no-files-found: warn

    - name: Upload mutation report JSON
      uses: actions/upload-artifact@5d5d22a31266ced268874388b861e4b58bb5c2f3  # v4.3.1
      if: always()
      continue-on-error: true
      with:
        name: mutation-report-json-${{ matrix.category }}
        path: |
          StrykerOutput/**/mutation-report.json
          **/mutation-report.json
        retention-days: 30
        if-no-files-found: warn

    - name: Upload Stryker logs
      uses: actions/upload-artifact@5d5d22a31266ced268874388b861e4b58bb5c2f3  # v4.3.1
      if: always()
      continue-on-error: true
      with:
        name: stryker-logs-${{ matrix.category }}
        path: |
          StrykerOutput/**/logs/
          **/stryker-log*.txt
        retention-days: 7
        if-no-files-found: ignore

    - name: Check mutation threshold
      if: steps.mutation-test.outcome == 'failure'
      run: |
        echo "::error::Mutation testing failed or threshold not met for ${{ matrix.category }}"
        echo "Review the artifacts to identify areas needing better"
        echo "test coverage."
        exit 1  # Fail the workflow when mutation tests fail

    - name: Job summary
      if: always()
      run: |
        OUTCOME="${{ steps.mutation-test.outcome }}"
        if [ "$OUTCOME" = "success" ]; then
          echo "âœ… Mutation testing completed successfully for ${{ matrix.category }}"
        else
          echo "âš ï¸ Mutation testing completed with issues for ${{ matrix.category }}"
          echo "Check the reports for details"
        fi

  # Aggregation job to combine results from all matrix jobs
  mutation-test-summary:
    name: Mutation Test Summary
    runs-on: ubuntu-latest
    needs: [check-submodules, mutation-test]
    if: always() && needs.check-submodules.outputs.available == 'true'
    timeout-minutes: 15

    steps:
    - name: Download all mutation report JSONs
      uses: actions/download-artifact@87c55149d96e628cc2ef7e6fc2aab372015aec85  # v4.1.8
      continue-on-error: true
      with:
        pattern: mutation-report-json-*
        path: MutationReports
        merge-multiple: false

    - name: Install jq
      run: |
        if ! command -v jq &> /dev/null; then
          echo "Installing jq..."
          sudo apt-get update && sudo apt-get install -y jq
        fi

    - name: Aggregate mutation results
      id: aggregate
      run: |
        echo "Aggregating mutation test results from all categories..."
        
        TOTAL_SCORE=0
        CATEGORY_COUNT=0
        CATEGORIES_FOUND=""
        CATEGORIES_MISSING=""
        
        # Expected categories
        CATEGORIES=(Core Domain Pipeline Tools Application Providers Agent CLI WebApi)
        
        for CATEGORY in "${CATEGORIES[@]}"; do
          REPORT_DIR="MutationReports/mutation-report-json-${CATEGORY}"
          REPORT=$(find "$REPORT_DIR" -name "mutation-report.json" -type f 2>/dev/null | head -n 1)
          
          if [ -f "$REPORT" ]; then
            echo "Found report for ${CATEGORY}: $REPORT"
            SCORE=$(jq -r '.thresholds.high // .mutationScore // 0' "$REPORT" 2>/dev/null || echo "0")
            echo "  Score: ${SCORE}"
            
            TOTAL_SCORE=$(echo "$TOTAL_SCORE + $SCORE" | bc)
            CATEGORY_COUNT=$((CATEGORY_COUNT + 1))
            CATEGORIES_FOUND="${CATEGORIES_FOUND}${CATEGORY} "
          else
            echo "No report found for ${CATEGORY}"
            CATEGORIES_MISSING="${CATEGORIES_MISSING}${CATEGORY} "
          fi
        done
        
        if [ $CATEGORY_COUNT -gt 0 ]; then
          AVG_SCORE=$(echo "scale=2; $TOTAL_SCORE / $CATEGORY_COUNT" | bc)
        else
          AVG_SCORE="0"
        fi
        
        echo "average_score=${AVG_SCORE}" >> $GITHUB_OUTPUT
        echo "categories_completed=${CATEGORY_COUNT}" >> $GITHUB_OUTPUT
        echo "categories_found=${CATEGORIES_FOUND}" >> $GITHUB_OUTPUT
        echo "categories_missing=${CATEGORIES_MISSING}" >> $GITHUB_OUTPUT
        
        echo "Summary: ${CATEGORY_COUNT} categories completed with average score ${AVG_SCORE}"

    - name: Generate combined summary
      if: always()
      run: |
        echo "## ðŸ§¬ Mutation Testing - Combined Summary" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        echo "### Overview" >> $GITHUB_STEP_SUMMARY
        echo "Mutation testing completed across **9 project categories** in parallel." >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        COMPLETED="${{ steps.aggregate.outputs.categories_completed }}"
        AVG_SCORE="${{ steps.aggregate.outputs.average_score }}"
        FOUND="${{ steps.aggregate.outputs.categories_found }}"
        MISSING="${{ steps.aggregate.outputs.categories_missing }}"
        
        echo "**Results:**" >> $GITHUB_STEP_SUMMARY
        echo "- Categories completed: ${COMPLETED}/9" >> $GITHUB_STEP_SUMMARY
        
        if [ -n "$AVG_SCORE" ] && [ "$AVG_SCORE" != "0" ]; then
          echo "- Average mutation score: ${AVG_SCORE}%" >> $GITHUB_STEP_SUMMARY
        fi
        
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### Categories Tested" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "| Category | Project |" >> $GITHUB_STEP_SUMMARY
        echo "|----------|---------|" >> $GITHUB_STEP_SUMMARY
        echo "| Core | Ouroboros.Core |" >> $GITHUB_STEP_SUMMARY
        echo "| Domain | Ouroboros.Domain |" >> $GITHUB_STEP_SUMMARY
        echo "| Pipeline | Ouroboros.Pipeline |" >> $GITHUB_STEP_SUMMARY
        echo "| Tools | Ouroboros.Tools |" >> $GITHUB_STEP_SUMMARY
        echo "| Application | Ouroboros.Application |" >> $GITHUB_STEP_SUMMARY
        echo "| Providers | Ouroboros.Providers |" >> $GITHUB_STEP_SUMMARY
        echo "| Agent | Ouroboros.Agent |" >> $GITHUB_STEP_SUMMARY
        echo "| CLI | Ouroboros.CLI |" >> $GITHUB_STEP_SUMMARY
        echo "| WebApi | Ouroboros.WebApi |" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        if [ -n "$FOUND" ]; then
          echo "**Completed categories:** ${FOUND}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
        fi
        
        if [ -n "$MISSING" ]; then
          echo "**Missing reports:** ${MISSING}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
        fi
        
        echo "### Configuration" >> $GITHUB_STEP_SUMMARY
        ML="${{ github.event.inputs.mutation_level || 'Standard' }}"
        echo "- Mutation Level: ${ML}" >> $GITHUB_STEP_SUMMARY
        echo "- Target Framework: net10.0" >> $GITHUB_STEP_SUMMARY
        echo "- Test Project: Ouroboros.Tests" >> $GITHUB_STEP_SUMMARY
        echo "- Parallel Jobs: 9" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        echo "### Thresholds" >> $GITHUB_STEP_SUMMARY
        echo "- ðŸŸ¢ High: â‰¥80%" >> $GITHUB_STEP_SUMMARY
        echo "- ðŸŸ¡ Low: â‰¥60%" >> $GITHUB_STEP_SUMMARY
        echo "- ðŸ”´ Break: <50%" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        echo "### Artifacts" >> $GITHUB_STEP_SUMMARY
        echo "Individual mutation reports (HTML and JSON) for each category are available as artifacts." >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        echo "---" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**About Mutation Testing:**" >> $GITHUB_STEP_SUMMARY
        echo "Mutation testing validates test quality by introducing small changes (mutations)" >> $GITHUB_STEP_SUMMARY
        echo "to the code and verifying that tests detect these changes. A high mutation score" >> $GITHUB_STEP_SUMMARY
        echo "indicates a robust test suite." >> $GITHUB_STEP_SUMMARY

  skipped-summary:
    name: Submodules Not Available
    needs: check-submodules
    if: needs.check-submodules.outputs.available == 'false'
    runs-on: ubuntu-latest
    timeout-minutes: 5
    steps:
    - name: Report skipped
      run: |
        echo "## âš ï¸ Mutation Testing Skipped" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "One or more sub-repo submodules could not be cloned." >> $GITHUB_STEP_SUMMARY
        echo "Ensure the submodule repositories are accessible to GitHub Actions." >> $GITHUB_STEP_SUMMARY
