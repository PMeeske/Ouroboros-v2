# Full build workflow for the Ouroboros meta-repo
# Builds and tests all sub-repos together

name: Full Build

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]
  workflow_dispatch:
  repository_dispatch:
    types: [dependency-updated]

concurrency:
  group: full-build-${{ github.event_name == 'repository_dispatch' && format('dispatch-{0}', github.event.client_payload.source_repo) || github.ref }}
  cancel-in-progress: true

permissions:
  contents: read

jobs:
  check-submodules:
    name: Check Submodule Availability
    runs-on: ubuntu-latest
    timeout-minutes: 5
    outputs:
      available: ${{ steps.check.outputs.available }}
    steps:
      - name: Checkout code
        uses: actions/checkout@b4ffde65f46336ab88eb53be808477a3936bae11  # v4.1.1

      - name: Try cloning submodules
        run: git submodule update --init --recursive 2>&1 || true

      - name: Check submodule availability
        id: check
        run: |
          MISSING=""
          for sub in .build foundation engine app; do
            if [ ! -f "$sub/.git" ] && [ ! -d "$sub/.git" ]; then
              MISSING="$MISSING $sub"
            fi
          done
          if [ -n "$MISSING" ]; then
            echo "available=false" >> $GITHUB_OUTPUT
            echo "::warning::Sub-repo(s) not available:$MISSING — skipping build and test jobs"
          else
            echo "available=true" >> $GITHUB_OUTPUT
            echo "All submodules available"
          fi

  build-all:
    name: Build All Projects
    needs: check-submodules
    if: needs.check-submodules.outputs.available == 'true'
    runs-on: ubuntu-latest
    timeout-minutes: 30

    steps:
      - name: Checkout with submodules
        uses: actions/checkout@b4ffde65f46336ab88eb53be808477a3936bae11  # v4.1.1
        with:
          fetch-depth: 0
          submodules: recursive

      - name: Setup .NET SDK
        uses: actions/setup-dotnet@4d6c8fcf3c8f7a60068d26b594648e99df24cee3  # v4.0.0
        with:
          dotnet-version: '10.0.x'

      - name: Install MAUI workloads
        run: dotnet workload install maui-android

      - name: Restore dependencies
        run: dotnet restore Ouroboros.slnx

      - name: Build solution
        run: dotnet build Ouroboros.slnx --configuration Release --no-restore

  test-foundation:
    name: Test Foundation
    needs: [check-submodules, build-all]
    if: needs.check-submodules.outputs.available == 'true'
    runs-on: ubuntu-latest
    timeout-minutes: 15
    steps:
      - uses: actions/checkout@b4ffde65f46336ab88eb53be808477a3936bae11
        with: { submodules: recursive }
      - uses: actions/setup-dotnet@4d6c8fcf3c8f7a60068d26b594648e99df24cee3
        with: { dotnet-version: '10.0.x' }
      - run: |
          dotnet test foundation/tests/Ouroboros.Core.Tests/Ouroboros.Core.Tests.csproj --configuration Release --logger "trx;LogFileName=results.trx"
          dotnet test foundation/tests/Ouroboros.Domain.Tests/Ouroboros.Domain.Tests.csproj --configuration Release --logger "trx;LogFileName=results.trx"
          dotnet test foundation/tests/Ouroboros.Tools.Tests/Ouroboros.Tools.Tests.csproj --configuration Release --logger "trx;LogFileName=results.trx"
          dotnet test foundation/tests/Ouroboros.Genetic.Tests/Ouroboros.Genetic.Tests.csproj --configuration Release --logger "trx;LogFileName=results.trx"

  test-engine:
    name: Test Engine
    needs: [check-submodules, build-all]
    if: needs.check-submodules.outputs.available == 'true'
    runs-on: ubuntu-latest
    timeout-minutes: 20
    steps:
      - uses: actions/checkout@b4ffde65f46336ab88eb53be808477a3936bae11
        with: { submodules: recursive }
      - uses: actions/setup-dotnet@4d6c8fcf3c8f7a60068d26b594648e99df24cee3
        with: { dotnet-version: '10.0.x' }
      - run: |
          dotnet test engine/tests/Ouroboros.Agent.Tests/Ouroboros.Agent.Tests.csproj --configuration Release --logger "trx;LogFileName=results.trx"
          dotnet test engine/tests/Ouroboros.Pipeline.Tests/Ouroboros.Pipeline.Tests.csproj --configuration Release --logger "trx;LogFileName=results.trx"
          dotnet test engine/tests/Ouroboros.Providers.Tests/Ouroboros.Providers.Tests.csproj --configuration Release --logger "trx;LogFileName=results.trx"
          dotnet test engine/tests/Ouroboros.Network.Tests/Ouroboros.Network.Tests.csproj --configuration Release --logger "trx;LogFileName=results.trx"

  test-app:
    name: Test App
    needs: [check-submodules, build-all]
    if: needs.check-submodules.outputs.available == 'true'
    runs-on: ubuntu-latest
    timeout-minutes: 20
    steps:
      - uses: actions/checkout@b4ffde65f46336ab88eb53be808477a3936bae11
        with: { submodules: recursive }
      - uses: actions/setup-dotnet@4d6c8fcf3c8f7a60068d26b594648e99df24cee3
        with: { dotnet-version: '10.0.x' }
      - run: |
          dotnet test app/tests/Ouroboros.CLI.Tests/Ouroboros.CLI.Tests.csproj --configuration Release --logger "trx;LogFileName=results.trx"
          dotnet test app/tests/Ouroboros.WebApi.Tests/Ouroboros.WebApi.Tests.csproj --configuration Release --logger "trx;LogFileName=results.trx"
          dotnet test app/tests/Ouroboros.Application.Tests/Ouroboros.Application.Tests.csproj --configuration Release --logger "trx;LogFileName=results.trx"

  skipped-summary:
    name: Submodules Not Available
    needs: check-submodules
    if: needs.check-submodules.outputs.available == 'false'
    runs-on: ubuntu-latest
    timeout-minutes: 5
    steps:
      - name: Report skipped
        run: |
          echo "## ⚠️ Full Build Skipped" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "One or more sub-repo submodules could not be cloned." >> $GITHUB_STEP_SUMMARY
          echo "Ensure the submodule repositories are accessible to GitHub Actions:" >> $GITHUB_STEP_SUMMARY
          echo "- \`ouroboros-build\`" >> $GITHUB_STEP_SUMMARY
          echo "- \`ouroboros-foundation\`" >> $GITHUB_STEP_SUMMARY
          echo "- \`ouroboros-engine\`" >> $GITHUB_STEP_SUMMARY
          echo "- \`ouroboros-app\`" >> $GITHUB_STEP_SUMMARY
