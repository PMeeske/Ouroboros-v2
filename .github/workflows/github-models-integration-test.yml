name: GitHub Models Integration Tests

on:
  push:
    branches: [ main, master ]
    paths:
      - 'foundation/**'
      - 'engine/**'
      - 'app/**'
      - '.build/**'
      - '**.csproj'
      - '.github/workflows/github-models-integration-test.yml'
  pull_request:
    branches: [ main, master ]
    paths:
      - 'foundation/**'
      - 'engine/**'
      - 'app/**'
      - '.build/**'
      - '**.csproj'
      - '.github/workflows/github-models-integration-test.yml'
  workflow_dispatch:

permissions:
  contents: read

# Cancel in-progress runs for the same workflow on the same branch
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

env:
  DOTNET_VERSION: '10.0.x'

jobs:
  check-submodules:
    name: Check Submodule Availability
    runs-on: ubuntu-latest
    timeout-minutes: 5
    outputs:
      available: ${{ steps.check.outputs.available }}
    steps:
    - name: Checkout code
      uses: actions/checkout@b4ffde65f46336ab88eb53be808477a3936bae11  # v4.1.1

    - name: Try cloning submodules
      run: git submodule update --init --recursive 2>&1 || true

    - name: Check submodule availability
      id: check
      run: |
        MISSING=""
        for sub in .build foundation engine app; do
          if [ ! -f "$sub/.git" ] && [ ! -d "$sub/.git" ]; then
            MISSING="$MISSING $sub"
          fi
        done
        if [ -n "$MISSING" ]; then
          echo "available=false" >> $GITHUB_OUTPUT
          echo "::warning::Sub-repo(s) not available:$MISSING â€” skipping GitHub Models integration tests"
        else
          echo "available=true" >> $GITHUB_OUTPUT
          echo "All submodules available"
        fi

  github-models-integration:
    name: GitHub Models Integration Tests
    needs: check-submodules
    if: needs.check-submodules.outputs.available == 'true' && (github.event_name == 'workflow_dispatch' || (github.event_name == 'push' && (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master')))
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
    - name: Checkout code
      uses: actions/checkout@b4ffde65f46336ab88eb53be808477a3936bae11  # v4.1.1
      with:
        fetch-depth: 0
        submodules: recursive

    - name: Setup .NET
      uses: actions/setup-dotnet@4d6c8fcf3c8f7a60068d26b594648e99df24cee3  # v4.0.0
      with:
        dotnet-version: ${{ env.DOTNET_VERSION }}

    - name: Cache NuGet packages
      uses: actions/cache@v4
      with:
        path: ~/.nuget/packages
        key: ${{ runner.os }}-nuget-${{ hashFiles('**/*.csproj') }}
        restore-keys: |
          ${{ runner.os }}-nuget-

    - name: Restore dependencies
      uses: nick-fields/retry@7152eba30c6575329ac0576536151aca5a72780e  # v3.0.0
      with:
        timeout_minutes: 10
        max_attempts: 3
        retry_wait_seconds: 30
        command: dotnet restore Ouroboros.slnx

    - name: Build
      run: |
        # Build CLI project and its dependencies for integration tests
        dotnet build app/src/Ouroboros.CLI/Ouroboros.CLI.csproj --configuration Release --no-restore
      timeout-minutes: 15

    - name: Test 1 - GitHub Models API Connectivity
      if: ${{ secrets.MODEL_TOKEN != '' }}
      uses: nick-fields/retry@7152eba30c6575329ac0576536151aca5a72780e  # v3.0.0
      env:
        MODEL_TOKEN: ${{ secrets.MODEL_TOKEN }}
      with:
        timeout_minutes: 5
        max_attempts: 2
        retry_wait_seconds: 10
        command: |
          echo "=== Test 1: GitHub Models API Connectivity ==="
          cd app/src/Ouroboros.CLI
          
          # Basic ask command to verify GitHub Models works
          dotnet run --no-build --configuration Release -- ask \
            -q "What is 2+2? Answer with just the number." \
            --model "gpt-4o-mini" \
            --endpoint-type github-models \
            --max-tokens 50
          
          echo "âœ“ GitHub Models connectivity test passed"

    - name: Test 2 - Pipeline DSL with GitHub Models
      if: ${{ secrets.MODEL_TOKEN != '' }}
      uses: nick-fields/retry@7152eba30c6575329ac0576536151aca5a72780e  # v3.0.0
      env:
        MODEL_TOKEN: ${{ secrets.MODEL_TOKEN }}
      with:
        timeout_minutes: 5
        max_attempts: 2
        retry_wait_seconds: 10
        command: |
          echo "=== Test 2: Pipeline DSL with GitHub Models ==="
          cd app/src/Ouroboros.CLI
          
          # Test pipeline DSL with draft step
          dotnet run --no-build --configuration Release -- pipeline \
            --dsl "SetPrompt('Explain functional programming in one sentence') | UseDraft" \
            --model "gpt-4o-mini" \
            --endpoint-type github-models \
            --max-tokens 100
          
          echo "âœ“ Pipeline DSL test passed"

    - name: Test 3 - Different Model Selection
      if: ${{ secrets.MODEL_TOKEN != '' }}
      uses: nick-fields/retry@7152eba30c6575329ac0576536151aca5a72780e  # v3.0.0
      env:
        MODEL_TOKEN: ${{ secrets.MODEL_TOKEN }}
      with:
        timeout_minutes: 5
        max_attempts: 2
        retry_wait_seconds: 10
        command: |
          echo "=== Test 3: Different Model Selection ==="
          cd app/src/Ouroboros.CLI
          
          # Test with gpt-4o model (standard model)
          dotnet run --no-build --configuration Release -- ask \
            -q "What is category theory in one line?" \
            --model "gpt-4o" \
            --endpoint-type github-models \
            --max-tokens 100
          
          echo "âœ“ Model selection test passed"

    - name: Skip Tests Notice
      if: ${{ secrets.MODEL_TOKEN == '' }}
      run: |
        echo "âš ï¸ MODEL_TOKEN secret is not set. Skipping GitHub Models integration tests."
        echo "To run these tests, add the MODEL_TOKEN secret to your repository."

    - name: Generate Test Summary
      if: always()
      run: |
        echo "## ðŸ§ª GitHub Models Integration Test Results" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### Environment" >> $GITHUB_STEP_SUMMARY
        echo "- **Runner**: ubuntu-latest" >> $GITHUB_STEP_SUMMARY
        echo "- **Models**: gpt-4o-mini, gpt-4o" >> $GITHUB_STEP_SUMMARY
        echo "- **.NET Version**: ${{ env.DOTNET_VERSION }}" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        if [ -n "${{ secrets.MODEL_TOKEN }}" ]; then
          echo "### Tests Executed" >> $GITHUB_STEP_SUMMARY
          echo "1. âœ… GitHub Models API Connectivity" >> $GITHUB_STEP_SUMMARY
          echo "2. âœ… Pipeline DSL with GitHub Models" >> $GITHUB_STEP_SUMMARY
          echo "3. âœ… Different Model Selection" >> $GITHUB_STEP_SUMMARY
        else
          echo "### âš ï¸ Tests Skipped" >> $GITHUB_STEP_SUMMARY
          echo "MODEL_TOKEN secret is not configured." >> $GITHUB_STEP_SUMMARY
        fi

  skipped-summary:
    name: Submodules Not Available
    needs: check-submodules
    if: needs.check-submodules.outputs.available == 'false'
    runs-on: ubuntu-latest
    timeout-minutes: 5
    steps:
    - name: Report skipped
      run: |
        echo "## âš ï¸ GitHub Models Integration Tests Skipped" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "One or more sub-repo submodules could not be cloned." >> $GITHUB_STEP_SUMMARY
        echo "Ensure the submodule repositories are accessible to GitHub Actions." >> $GITHUB_STEP_SUMMARY
