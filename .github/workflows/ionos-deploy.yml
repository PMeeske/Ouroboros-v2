name: IONOS Cloud Deployment

on:
  push:
    branches: [main]
  workflow_dispatch:

# Prevent concurrent deployments to the same environment
concurrency:
  group: ionos-deployment-${{ github.ref }}
  cancel-in-progress: false

env:
  IONOS_REGISTRY: ${{ vars.IONOS_REGISTRY || '<your-registry>.cr.<region>.ionos.com' }}
  NAMESPACE: monadic-pipeline
  CONTAINER_NAME_CLI: monadic-pipeline
  CONTAINER_NAME_WEBAPI: monadic-pipeline-webapi
  DOTNET_VERSION: '10.0.x'

jobs:
  check-submodules:
    name: Check Submodule Availability
    runs-on: ubuntu-latest
    timeout-minutes: 5
    permissions:
      contents: read
    outputs:
      available: ${{ steps.check.outputs.available }}
    steps:
      - name: Checkout code
        uses: actions/checkout@b4ffde65f46336ab88eb53be808477a3936bae11  # v4.1.1

      - name: Try cloning submodules
        run: git submodule update --init --recursive 2>&1 || true

      - name: Check submodule availability
        id: check
        run: |
          MISSING=""
          for sub in .build foundation engine app; do
            if [ ! -f "$sub/.git" ] && [ ! -d "$sub/.git" ]; then
              MISSING="$MISSING $sub"
            fi
          done
          if [ -n "$MISSING" ]; then
            echo "available=false" >> $GITHUB_OUTPUT
            echo "::warning::Sub-repo(s) not available:$MISSING — skipping test and deploy jobs"
          else
            echo "available=true" >> $GITHUB_OUTPUT
            echo "All submodules available"
          fi

  infrastructure:
    name: Manage IONOS Infrastructure
    runs-on: ubuntu-latest
    timeout-minutes: 15
    permissions:
      contents: read
    steps:
      - name: Checkout repository
        uses: actions/checkout@b4ffde65f46336ab88eb53be808477a3936bae11  # v4.1.1

      - name: Verify IONOS Cloud API access
        env:
          IONOS_USERNAME: ${{ secrets.IONOS_ADMIN_USERNAME }}
          IONOS_PASSWORD: ${{ secrets.IONOS_ADMIN_PASSWORD }}
          IONOS_TOKEN: ${{ secrets.IONOS_ADMIN_TOKEN }}
        timeout-minutes: 5
        run: |
          echo "Verifying IONOS Cloud API connectivity..."

          # Use token if available, otherwise use basic auth
          if [ -n "$IONOS_TOKEN" ]; then
            AUTH_HEADER="Authorization: Bearer $IONOS_TOKEN"
          elif [ -n "$IONOS_USERNAME" ] && [ -n "$IONOS_PASSWORD" ]; then
            AUTH_HEADER="Authorization: Basic $(echo -n "$IONOS_USERNAME:$IONOS_PASSWORD" | base64)"
          else
            echo "⚠️  Warning: No IONOS admin credentials provided. Skipping infrastructure verification."
            echo "Set IONOS_ADMIN_USERNAME/IONOS_ADMIN_PASSWORD or IONOS_ADMIN_TOKEN secrets to enable infrastructure management."
            exit 0
          fi

          # Test API connectivity using IONOS Cloud API v6
          response=$(curl -s -w "\n%{http_code}" -H "$AUTH_HEADER" \
            -H "Content-Type: application/json" \
            https://api.ionos.com/cloudapi/v6/ || echo "000")

          http_code=$(echo "$response" | tail -n1)

          if [ "$http_code" = "200" ]; then
            echo "✓ Successfully connected to IONOS Cloud API"
            echo "✓ API Specification: .github/workflows/ionos-api.yaml"
          elif [ "$http_code" = "401" ]; then
            echo "❌ Authentication failed. Please verify IONOS_ADMIN credentials."
            exit 1
          elif [ "$http_code" = "000" ]; then
            echo "❌ Failed to connect to IONOS Cloud API"
            exit 1
          else
            echo "⚠️  Unexpected HTTP status code: $http_code"
            echo "Response: $(echo "$response" | head -n -1)"
          fi

      - name: Ensure infrastructure prerequisites
        env:
          IONOS_USERNAME: ${{ secrets.IONOS_ADMIN_USERNAME }}
          IONOS_PASSWORD: ${{ secrets.IONOS_ADMIN_PASSWORD }}
          IONOS_TOKEN: ${{ secrets.IONOS_ADMIN_TOKEN }}
        timeout-minutes: 5
        run: |
          # Skip if no credentials
          if [ -z "$IONOS_TOKEN" ] && [ -z "$IONOS_USERNAME" ]; then
            echo "⚠️  Skipping infrastructure management - no admin credentials configured"
            exit 0
          fi

          echo "Infrastructure management capabilities enabled via IONOS Cloud API v6"
          echo "API Reference: .github/workflows/ionos-api.yaml"
          echo ""
          echo "Available infrastructure operations:"
          echo "  - Data centers management"
          echo "  - Kubernetes cluster provisioning"
          echo "  - Network configuration"
          echo "  - Storage provisioning"
          echo ""
          echo "✅ Infrastructure as Code (IaC) available:"
          echo "   - Terraform configurations: terraform/"
          echo "   - Automated provisioning workflow: .github/workflows/terraform-infrastructure.yml"
          echo "   - Environment configs: terraform/environments/"
          echo ""
          echo "To provision infrastructure automatically, run the 'Terraform Infrastructure' workflow"
          echo "or use: cd terraform && terraform apply -var-file=environments/production.tfvars"

  test:
    name: Run Tests
    needs: [check-submodules, infrastructure]
    if: needs.check-submodules.outputs.available == 'true'
    timeout-minutes: 20
    permissions:
      contents: read
      checks: write
      pull-requests: write
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@b4ffde65f46336ab88eb53be808477a3936bae11  # v4.1.1
        with:
          submodules: recursive

      - name: Setup .NET
        uses: actions/setup-dotnet@4d6c8fcf3c8f7a60068d26b594648e99df24cee3  # v4.0.0
        with:
          dotnet-version: ${{ env.DOTNET_VERSION }}

      - name: Restore dependencies
        uses: nick-fields/retry@7152eba30c6575329ac0576536151aca5a72780e  # v3.0.0
        with:
          timeout_minutes: 10
          max_attempts: 3
          retry_wait_seconds: 30
          command: dotnet restore Ouroboros.slnx

      - name: Build
        run: dotnet build Ouroboros.slnx --no-restore --configuration Release
        timeout-minutes: 15

      - name: Run xUnit tests
        run: |
          # Run tests using the solution
          dotnet test Ouroboros.slnx --configuration Release --no-build --verbosity normal \
            --logger "trx;LogFileName=test-results.trx"
          EXIT_CODE=$?
          
          if [ $EXIT_CODE -ne 0 ]; then
            echo "::warning::Tests failed with exit code $EXIT_CODE"
            echo "Check test results artifact for details"
          fi
        timeout-minutes: 15
        continue-on-error: true

      - name: Publish test results
        uses: EnricoMi/publish-unit-test-result-action@30eadd5010312f995f0d3b3cff7fe2984f69409e  # v2.16.1
        if: always()
        with:
          files: '**/test-results.trx'

  build-and-push:
    name: Build and Push Images
    needs: [check-submodules, test]
    if: needs.check-submodules.outputs.available == 'true'
    runs-on: ubuntu-latest
    timeout-minutes: 60
    permissions:
      contents: read
    steps:
      - name: Checkout repository
        uses: actions/checkout@b4ffde65f46336ab88eb53be808477a3936bae11  # v4.1.1
        with:
          submodules: recursive

      - name: Validate registry credentials
        env:
          IONOS_REGISTRY_USERNAME: ${{ secrets.IONOS_REGISTRY_USERNAME }}
          IONOS_REGISTRY_PASSWORD: ${{ secrets.IONOS_REGISTRY_PASSWORD }}
        run: |
          if [ -z "$IONOS_REGISTRY_USERNAME" ] || [ -z "$IONOS_REGISTRY_PASSWORD" ]; then
            echo "❌ Error: IONOS Container Registry credentials not configured"
            echo "Please set IONOS_REGISTRY_USERNAME and IONOS_REGISTRY_PASSWORD secrets"
            exit 1
          fi
          echo "✓ Registry credentials are configured"

      - name: Login to IONOS Container Registry
        uses: docker/login-action@e92390c5fb421da1463c202d546fed0ec5c39f20  # v3.1.0
        with:
          registry: ${{ env.IONOS_REGISTRY }}
          username: ${{ secrets.IONOS_REGISTRY_USERNAME }}
          password: ${{ secrets.IONOS_REGISTRY_PASSWORD }}
        timeout-minutes: 5

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@2b51285047da1547ffb1b2203d8be4c0af6b1f20  # v3.2.0

      - name: Build and push CLI image
        uses: docker/build-push-action@2cdde995de11925a030ce8070c3d77a52ffcf1c0  # v5.3.0
        with:
          context: .
          file: ./Dockerfile
          push: true
          tags: |
            ${{ env.IONOS_REGISTRY }}/${{ env.CONTAINER_NAME_CLI }}:latest
            ${{ env.IONOS_REGISTRY }}/${{ env.CONTAINER_NAME_CLI }}:${{ github.sha }}
          cache-from: type=gha
          cache-to: type=gha,mode=max
        timeout-minutes: 30

      - name: Build and push WebAPI image
        uses: docker/build-push-action@2cdde995de11925a030ce8070c3d77a52ffcf1c0  # v5.3.0
        with:
          context: .
          file: ./Dockerfile.webapi
          push: true
          tags: |
            ${{ env.IONOS_REGISTRY }}/${{ env.CONTAINER_NAME_WEBAPI }}:latest
            ${{ env.IONOS_REGISTRY }}/${{ env.CONTAINER_NAME_WEBAPI }}:${{ github.sha }}
          cache-from: type=gha
          cache-to: type=gha,mode=max
        timeout-minutes: 30

  deploy:
    name: Deploy to IONOS Kubernetes
    needs: [build-and-push]
    runs-on: ubuntu-latest
    permissions:
      contents: read
    timeout-minutes: 30
    steps:
      - name: Checkout repository
        uses: actions/checkout@b4ffde65f46336ab88eb53be808477a3936bae11  # v4.1.1

      - name: Validate Kubernetes configuration
        id: validate-k8s
        env:
          IONOS_KUBECONFIG: ${{ secrets.IONOS_KUBECONFIG }}
        run: |
          if [ -z "$IONOS_KUBECONFIG" ]; then
            echo "has_kubeconfig=false" >> $GITHUB_OUTPUT
            echo "⚠️  Warning: IONOS Kubernetes configuration not found"
            echo "Please set IONOS_KUBECONFIG secret to enable deployment"
            echo "Skipping deployment"
          else
            echo "has_kubeconfig=true" >> $GITHUB_OUTPUT
            echo "✓ Kubernetes configuration is available"
          fi

      - name: Setup kubectl
        if: steps.validate-k8s.outputs.has_kubeconfig == 'true'
        uses: azure/setup-kubectl@901a10e89ea615cf61f57ac05cecdf23e7de06d8  # v3.2
        with:
          version: 'latest'

      - name: Configure kubectl for IONOS
        if: steps.validate-k8s.outputs.has_kubeconfig == 'true'
        uses: nick-fields/retry@7152eba30c6575329ac0576536151aca5a72780e  # v3.0.0
        with:
          timeout_minutes: 5
          max_attempts: 3
          retry_wait_seconds: 10
          command: |
            echo "${{ secrets.IONOS_KUBECONFIG }}" > kubeconfig.yaml
            export KUBECONFIG=$(pwd)/kubeconfig.yaml
            kubectl cluster-info
            echo "KUBECONFIG=$(pwd)/kubeconfig.yaml" >> $GITHUB_ENV

      - name: Validate IONOS prerequisites
        if: steps.validate-k8s.outputs.has_kubeconfig == 'true'
        timeout-minutes: 5
        run: |
          echo "Validating IONOS Cloud prerequisites..."

          # Check storage class
          if kubectl get storageclass ionos-enterprise-ssd &> /dev/null; then
            echo "✓ IONOS storage class 'ionos-enterprise-ssd' found"
          else
            echo "⚠️  Warning: IONOS storage class 'ionos-enterprise-ssd' not found"
            echo "Available storage classes:"
            kubectl get storageclass
            echo ""
            echo "This may cause PVC provisioning issues during deployment"
          fi

          # Check cluster nodes
          NODE_COUNT=$(kubectl get nodes --no-headers 2>/dev/null | wc -l)
          if [ "$NODE_COUNT" -gt 0 ]; then
            echo "✓ Cluster has $NODE_COUNT node(s)"
          else
            echo "⚠️  Warning: Unable to detect cluster nodes"
          fi

      - name: Create namespace
        if: steps.validate-k8s.outputs.has_kubeconfig == 'true'
        uses: nick-fields/retry@7152eba30c6575329ac0576536151aca5a72780e  # v3.0.0
        with:
          timeout_minutes: 3
          max_attempts: 3
          retry_wait_seconds: 5
          command: kubectl create namespace ${{ env.NAMESPACE }} --dry-run=client -o yaml | kubectl apply -f -

      - name: Create registry pull secret
        if: steps.validate-k8s.outputs.has_kubeconfig == 'true'
        uses: nick-fields/retry@7152eba30c6575329ac0576536151aca5a72780e  # v3.0.0
        with:
          timeout_minutes: 3
          max_attempts: 3
          retry_wait_seconds: 5
          command: |
            kubectl create secret docker-registry ionos-registry-secret \
              --docker-server=${{ env.IONOS_REGISTRY }} \
              --docker-username=${{ secrets.IONOS_REGISTRY_USERNAME }} \
              --docker-password=${{ secrets.IONOS_REGISTRY_PASSWORD }} \
              --namespace=${{ env.NAMESPACE }} \
              --dry-run=client -o yaml | kubectl apply -f -

      - name: Prepare deployment manifests
        if: steps.validate-k8s.outputs.has_kubeconfig == 'true'
        timeout-minutes: 5
        run: |
          # Create temporary directory for processed manifests
          mkdir -p /tmp/k8s-manifests

          # Copy and process cloud deployment manifests
          cp k8s/deployment.cloud.yaml /tmp/k8s-manifests/deployment.yaml
          cp k8s/webapi-deployment.cloud.yaml /tmp/k8s-manifests/webapi-deployment.yaml
          cp k8s/qdrant.yaml /tmp/k8s-manifests/qdrant.yaml
          cp k8s/ollama.yaml /tmp/k8s-manifests/ollama.yaml

          # Replace REGISTRY_URL with actual IONOS registry URL
          REGISTRY_URL="${{ env.IONOS_REGISTRY }}"
          sed -i "s|REGISTRY_URL|${REGISTRY_URL}|g" /tmp/k8s-manifests/deployment.yaml
          sed -i "s|REGISTRY_URL|${REGISTRY_URL}|g" /tmp/k8s-manifests/webapi-deployment.yaml

          # Update storage class for IONOS
          sed -i "s|storageClassName: managed-csi|storageClassName: ionos-enterprise-ssd|g" /tmp/k8s-manifests/qdrant.yaml
          sed -i "s|storageClassName: managed-csi|storageClassName: ionos-enterprise-ssd|g" /tmp/k8s-manifests/ollama.yaml

          # Enable imagePullSecrets for IONOS registry
          sed -i 's|# imagePullSecrets:|imagePullSecrets:|g' /tmp/k8s-manifests/deployment.yaml
          sed -i 's|#   - name: ionos-registry-secret|  - name: ionos-registry-secret|g' /tmp/k8s-manifests/deployment.yaml
          sed -i 's|# imagePullSecrets:|imagePullSecrets:|g' /tmp/k8s-manifests/webapi-deployment.yaml
          sed -i 's|#   - name: ionos-registry-secret|  - name: ionos-registry-secret|g' /tmp/k8s-manifests/webapi-deployment.yaml

      - name: Apply secrets and configmap
        if: steps.validate-k8s.outputs.has_kubeconfig == 'true'
        uses: nick-fields/retry@7152eba30c6575329ac0576536151aca5a72780e  # v3.0.0
        with:
          timeout_minutes: 5
          max_attempts: 3
          retry_wait_seconds: 10
          command: |
            echo "⚠️  Applying secrets - ensure k8s/secrets.yaml is updated for production!"
            kubectl apply -f k8s/secrets.yaml
            kubectl apply -f k8s/configmap.yaml

      - name: Deploy dependencies
        if: steps.validate-k8s.outputs.has_kubeconfig == 'true'
        uses: nick-fields/retry@7152eba30c6575329ac0576536151aca5a72780e  # v3.0.0
        with:
          timeout_minutes: 10
          max_attempts: 3
          retry_wait_seconds: 15
          command: |
            kubectl apply -f /tmp/k8s-manifests/ollama.yaml
            kubectl apply -f /tmp/k8s-manifests/qdrant.yaml
            kubectl apply -f k8s/jaeger.yaml

      - name: Deploy applications
        if: steps.validate-k8s.outputs.has_kubeconfig == 'true'
        uses: nick-fields/retry@7152eba30c6575329ac0576536151aca5a72780e  # v3.0.0
        with:
          timeout_minutes: 10
          max_attempts: 3
          retry_wait_seconds: 15
          command: |
            kubectl apply -f /tmp/k8s-manifests/deployment.yaml
            kubectl apply -f /tmp/k8s-manifests/webapi-deployment.yaml

      - name: Wait for deployments
        if: steps.validate-k8s.outputs.has_kubeconfig == 'true'
        timeout-minutes: 10
        run: |
          echo "Waiting for deployments to be ready..."

          DEPLOYMENT_WARNINGS=0

          # Function to wait with better feedback
          wait_for_deployment() {
            local deployment=$1
            echo "Waiting for $deployment..."
            if kubectl wait --for=condition=available --timeout=300s "deployment/$deployment" -n ${{ env.NAMESPACE }} 2>&1; then
              echo "✓ $deployment is ready"
              return 0
            else
              echo "⚠️  Warning: $deployment did not become ready within timeout"
              return 1
            fi
          }

          wait_for_deployment "ollama" || ((DEPLOYMENT_WARNINGS++))
          wait_for_deployment "qdrant" || ((DEPLOYMENT_WARNINGS++))
          wait_for_deployment "monadic-pipeline" || ((DEPLOYMENT_WARNINGS++))
          wait_for_deployment "monadic-pipeline-webapi" || ((DEPLOYMENT_WARNINGS++))

          if [ "$DEPLOYMENT_WARNINGS" -gt 0 ]; then
            echo ""
            echo "⚠️  $DEPLOYMENT_WARNINGS deployment(s) did not become ready"
            echo "Check pod status: kubectl get pods -n ${{ env.NAMESPACE }}"
          fi

      - name: Deployment summary
        if: always() && steps.validate-k8s.outputs.has_kubeconfig == 'true'
        run: |
          echo "================================================"
          echo "Deployment Complete!"
          echo "================================================"
          echo ""
          echo "Images deployed:"
          echo "  - ${{ env.IONOS_REGISTRY }}/${{ env.CONTAINER_NAME_CLI }}:${{ github.sha }}"
          echo "  - ${{ env.IONOS_REGISTRY }}/${{ env.CONTAINER_NAME_WEBAPI }}:${{ github.sha }}"
          echo ""
          echo "Namespace: ${{ env.NAMESPACE }}"
          echo "Storage class: ionos-enterprise-ssd"
          echo ""
          echo "Check deployment status:"
          kubectl get all -n ${{ env.NAMESPACE }}
          echo ""
          kubectl get pvc -n ${{ env.NAMESPACE }}
      
      - name: Deployment skipped
        if: steps.validate-k8s.outputs.has_kubeconfig == 'false'
        run: |
          echo "## ⚠️  Deployment Skipped" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "IONOS Kubernetes configuration is not available." >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "To enable deployment, configure the \`IONOS_KUBECONFIG\` secret." >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "You can generate a kubeconfig by:" >> $GITHUB_STEP_SUMMARY
          echo "1. Running the Terraform Infrastructure workflow" >> $GITHUB_STEP_SUMMARY
          echo "2. Downloading the kubeconfig artifact" >> $GITHUB_STEP_SUMMARY
          echo "3. Adding it as the \`IONOS_KUBECONFIG\` secret" >> $GITHUB_STEP_SUMMARY

      - name: Cleanup on failure
        if: failure()
        continue-on-error: true
        run: |
          echo "Cleaning up resources on failure..."
          # Remove kubeconfig file
          rm -f kubeconfig.yaml
          # Log failure details
          echo "Deployment failed. Check logs above for details."
          kubectl get events -n ${{ env.NAMESPACE }} --sort-by='.lastTimestamp' | tail -20 || true

  skipped-summary:
    name: Submodules Not Available
    needs: check-submodules
    if: needs.check-submodules.outputs.available == 'false'
    runs-on: ubuntu-latest
    timeout-minutes: 5
    permissions: {}
    steps:
      - name: Report skipped
        run: |
          echo "## ⚠️ IONOS Deployment Skipped" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "One or more sub-repo submodules could not be cloned." >> $GITHUB_STEP_SUMMARY
          echo "Ensure the submodule repositories are accessible to GitHub Actions." >> $GITHUB_STEP_SUMMARY
