# README Badge Update Workflow

This document describes the automated badge update system for the Ouroboros project README.

## Overview

The test and coverage badges in `README.md` are automatically updated by the `.NET Test Grid` workflow:

- **Workflow file**: `.github/workflows/dotnet-test-grid.yml`
- **Job**: `update-readme`

This unified approach ensures badges are updated after the comprehensive test matrix completes.

## Workflow: dotnet-test-grid.yml

### Purpose
The main test workflow that runs tests across multiple categories and updates badges as a final step.

### update-readme Job
This job runs after all test matrix jobs and coverage report generation. It:
1. Downloads test results from all matrix jobs
2. Downloads the aggregated coverage report
3. Calculates total test counts
4. Extracts coverage percentage
5. Updates README badges
6. Commits if changed

### When It Runs
- On push to `main` branch
- On manual workflow dispatch when targeting `main` branch
- Only after successful test and coverage jobs
- Part of the comprehensive test grid workflow

## Technical Details

### Test Result Parsing
Test counts are extracted from `.trx` (Visual Studio Test Results) files using regex:
```bash
PASSED=$(grep -oP 'Counters[^>]*passed="\K[0-9]+' "$TRX_FILE" | head -1)
FAILED=$(grep -oP 'Counters[^>]*failed="\K[0-9]+' "$TRX_FILE" | head -1)
```

### Coverage Extraction
Coverage percentage is extracted from `SummaryGithub.md` generated by ReportGenerator:
```bash
COVERAGE=$(grep -oP '(?:Line coverage:|Lines:)\s*\K[0-9.]+(?=%)?' CoverageReport/SummaryGithub.md | head -1)
```

### Badge URL Format
Badges use shields.io with the format:
```
https://img.shields.io/badge/{LABEL}-{MESSAGE}-{COLOR}
```

Spaces are encoded as `%20`, commas as `%2C`, and percent signs as `%25`.

### Commit Message
Changes are committed with the message:
```
chore: update test coverage badges [skip ci]
```

The `[skip ci]` tag prevents the commit from triggering CI workflows, avoiding infinite loops.

## Troubleshooting

### Badges Not Updating

1. **Check workflow runs**: Go to Actions tab and verify the workflow completed successfully
2. **Check test results**: Ensure tests are actually running and producing results
3. **Check permissions**: Workflow needs `contents: write` permission
4. **Check branch**: Workflows only run on `main` branch (for integrated workflow)

### Incorrect Badge Values

1. **Check coverage report**: Verify `CoverageReport/SummaryGithub.md` is generated correctly
2. **Check test results**: Verify `.trx` files contain correct test counts
3. **Review workflow logs**: Look for parsing errors in "Calculate total test counts" and "Parse coverage percentage" steps

### Debugging

The workflow includes extensive logging:
- Lists files being processed
- Shows extracted values
- Displays before/after badge URLs
- Logs color calculations

Check the workflow logs for detailed information about what's happening.

## Badge Requirements Summary

### Coverage Badge
- URL: `https://img.shields.io/badge/coverage-{PERCENTAGE}%25-{COLOR}`
- Colors:
  - Green (≥80%)
  - Yellow (≥50%)
  - Orange (≥20%)
  - Red (<20%)

### Tests Badge
- URL: `https://img.shields.io/badge/tests-{PASSED}%20passing-{COLOR}` (or with failures)
- Colors:
  - Green (all pass)
  - Red (any failures)

### Commit Behavior
- Only commits when values actually change
- Uses `[skip ci]` in commit message
- Committed by `github-actions[bot]`

## Files Modified

- `.github/workflows/dotnet-test-grid.yml` - Unified workflow with badge update job
- `README.md` - Badges are automatically updated (tests and coverage shields.io badges)

## Current Status

The unified workflow in `dotnet-test-grid.yml`:
1. Runs the full test matrix across all categories
2. Aggregates coverage from all test runs
3. Updates README badges with actual test counts and coverage percentage
4. Commits changes only when values change

Badges are updated on:
- Push to `main` branch
- Manual workflow dispatch
