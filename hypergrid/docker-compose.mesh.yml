##
## Ouroboros Hypergrid â€” 3-Node Iaret Mesh
##
## Usage:
##   docker compose -f hypergrid/docker-compose.mesh.yml build
##   docker compose -f hypergrid/docker-compose.mesh.yml up
##
## Each node runs a full convergent Iaret identity (4 aspects + synthesis)
## backed by a shared Ollama instance for LLM inference.
##

services:
  ollama:
    image: ollama/ollama:latest
    ports:
      - "11434:11434"
    volumes:
      - ollama-data:/root/.ollama

  iaret-alpha:
    build:
      context: ..
      dockerfile: hypergrid/src/Ouroboros.Hypergrid.Node/Dockerfile
    ports:
      - "9500:9500"
    environment:
      NODE_ID: alpha
      NODE_X: "0"
      NODE_Y: "0"
      NODE_Z: "0"
      OLLAMA_URL: http://ollama:11434
      OLLAMA_MODEL: deepseek-v3.1:671b-cloud
      MESH_PEERS: http://iaret-beta:9500,http://iaret-gamma:9500
    depends_on:
      - ollama

  iaret-beta:
    build:
      context: ..
      dockerfile: hypergrid/src/Ouroboros.Hypergrid.Node/Dockerfile
    ports:
      - "9501:9500"
    environment:
      NODE_ID: beta
      NODE_X: "0"
      NODE_Y: "0"
      NODE_Z: "1"
      OLLAMA_URL: http://ollama:11434
      OLLAMA_MODEL: deepseek-v3.1:671b-cloud
      MESH_PEERS: http://iaret-alpha:9500,http://iaret-gamma:9500
    depends_on:
      - ollama

  iaret-gamma:
    build:
      context: ..
      dockerfile: hypergrid/src/Ouroboros.Hypergrid.Node/Dockerfile
    ports:
      - "9502:9500"
    environment:
      NODE_ID: gamma
      NODE_X: "0"
      NODE_Y: "1"
      NODE_Z: "0"
      OLLAMA_URL: http://ollama:11434
      OLLAMA_MODEL: deepseek-v3.1:671b-cloud
      MESH_PEERS: http://iaret-alpha:9500,http://iaret-beta:9500
    depends_on:
      - ollama

volumes:
  ollama-data:
